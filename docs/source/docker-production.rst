CGAP-Docker (Production)
========================

CGAP-Docker runs in production on AWS Elastic Container Service, meant to be orchestrated from the 4dn-cloud-infra repository. End users will modify ``deploy/docker/production/Makefile`` to suite their immediate build needs with respect to target AWS Account/ECR Repository/Tagging strategy. For more information on the specifics of the ECS setup, see 4dn-cloud-infra.

The CGAP Application has been orchestrated into the ECS Service/Task paradigm. As of writing all core application services have their own image tag varied by passing the ``$ENTRYPOINT`` build argument. As such, they are all separate services with the following notable characteristics:

    * WSGI - services standard API requests - 8x parallelization on Fargate Spot
    * Indexer - hits /index at 3 second intervals indefinitely - 4x parallelization on Fargate Spot
    * Ingester - poll for ingestion tasks from SQS - 1x parallelization TODO add ability to add additional tasks through API
    * Deployment - triggers the standard deployment actions - must be explicitly run either through ECS console or TODO through API.

Building an Image
^^^^^^^^^^^^^^^^^

The production application configuration is in ``deploy/docker/production``. A description of all the relevant files follows.

    * Dockerfile - at repo top level - configurable file that builds both all local and production images.
    * docker-compose.yml - at repo top level - configures the local deployment - unused in production.
    * assume_identity.py - script for pulling application configuration from Secrets Manager. Note that this secret is meant to be generated by the Datastore stack in 4dn-cloud-infra and manually filled out.
    * entrypoint.sh - WSGI entrypoint
    * entrypoint_deployment.sh - deployment entrypoint
    * entrypoint_indexer.sh - indexer entrypoint
    * entrypoint_ingester.sh - ingester entrypoint
    * install_nginx.sh - script for pulling in nginx
    * Makefile - configures builds/pushes for relevant images/tags
    * mastertest.ini - base ini file used to build production.ini on the server
    * nginx.conf - nginx configuration


The following instructions describe how to build and push images. Note though that we assume an existing ECS setup. For instructions on how to orchestrate ECS, see 4dn-cloud-infra, but that is not the focus of this documentation.

    1. Ensure the orchestrator credentials are sourced, or that your IAM user has been granted sufficient perms to push to ECR.
    2. In the Makefile, replace "cgap-mastertest" with the env.name configured for the environment. This name should match the ECR repo name if you navigate to the ECR Console.
    3. Again in the Makefile, replace the ECR Repo URL (NOT the tags) with the one from the output of the ECR stack in the account.
    4. Run ``make login``, which should pull ECR credentials using the currently active AWS credentials.
    5. Run ``make info`` for information on tags.
    6. Run the appropriate make target to build/deploy the desired version by pushing a new image to ECR. Note that the upload process may take a long time if you made application code (non-configuration) changes.


Note that steps 1, 4 and 6 are all that are needed to be repeated once initial setup is done, assuming you are continuously pushing to the same location. To change which ECS orchestration you are effectively deploying to, all steps must be repeated in the relevant account.
